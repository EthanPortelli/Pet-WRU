<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selected Pets</title>
    <link rel="stylesheet" href="selectedPostStyle.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://kit.fontawesome.com/2e1a459034.js" crossorigin="anonymous"></script>
</head>
<body>
    <!-- Top Navigation Bar -->
    <!--each icon on navigation bar should take you to respectable page-->
    <div class="navbar" id="myNavbar" >
        <!-- Logo -->
        <img src="projectImages/logo.png" alt="Logo" title="Logo of Application" height="100px">
        
        <!-- Navigation Links -->
        <!--each link references another html page-->
        <div class="nav-links" id="navLinks">
            <a href="mainpage.html"><i class="fa fa-fw fa-home"></i> Home</a>
            <div class="dropdown">
                <button class="dropbtn">Posts 
                    <i class="fa fa-caret-down"></i>
                </button>
                <div class="dropdown-content">
                    <a href="missingPetPost.html" class="auth-link"><i class="fa-solid fa-paw"></i> Missing pets</a>
                    <a href="ReunitedPets.html" class="auth-link"><i class="fa-solid fa-paw"></i> Reunited pets</a>        
                </div>
            </div>
            <a href="donationPostPage.html" class="auth-link"><i class="fa-solid fa-box"></i> Donations</a>
            <div class="dropdown">
                <button class="dropbtn">Account 
                    <i class="fa fa-caret-down"></i>
                </button>
                <div class="dropdown-content">
                    <a href="userpage.html"><i class="fa-solid fa-circle-user"></i> Account Profile</a>
                    <a href="#" id="signOut"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</a>        
                </div>
            </div>
        </div>
        <a href="javascript:void(0);" class="icon" onclick="myFunction()">&#9776;</a>
    </div>

    <div class="post-container">
        <header class="post-header">
            <h1>Sunny</h1>
        </header>

        <section class="post-details">
            <div class="post-image">
                <img src="projectImages/Goldenret.jpeg" alt="dog">
                <div class="post-actions">
                    <h2>Created by username</h2>
                </div>
            </div>
            <div class="post-info">
                <div class="post-info-row description">
                    <strong>Description</strong>
                    <p>blah blah blah blah blah</p>
                </div>
                <div class="post-info-row species">
                    <strong>Type of Animal</strong>
                    <div class="species">
                        <p >Dog</p>
                    </div>
                </div>
                <div class="post-info-row">
                    <strong>Color</strong>
                    <p>Golden/yellow</p>
                </div>
                <div class="post-info-row">
                    <strong>Size</strong>
                    <p>Large</p>
                </div>
                <div class="post-info-row">
                    <strong>Gender</strong>
                    <p>Female</p>
                </div>
                <div class="post-info-row">
                    <strong>Last Known Location</strong>
                    <div class="location-container">
                        <p>St Agnes Rd, Uniondale</p>
                        <button type="submit" class="btn location-btn" onclick="openPopup()">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    <div class="popup" id="popup"> 
                        <div id="map"></div>
                        <!-- <img src = "projectImages/oakst.png"> -->
                        <button type="button" onclick="closePopup()"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <div class="post-info-row">
                    <strong>Date Went Missing</strong>
                    <p>2/01/2025</p>
                </div>
            </div>
        </section>

        <section class="post-feedback">
            <h2>Comments</h2>
            <form id="feedback-form" action="#" method="POST">
                <textarea name="comment" id="comment-text" rows="5" placeholder="Write your comment here..." required></textarea>
                <button type="submit" class="submit_button"> Post</button>
            </form>
        </section>
    </div>
        <footer>
            <div class="footer-links">
                <a href="aboutUs.html">About us</a>
                <a href="resource.html">Resources</a>
                <a href="https://github.com/jennefercampoverde/Pet-WRU.git">GitHub</a>
            </div>
            <p class="copyright">&copy; 2025 Pet WRU. All rights reserved.</p>
        </footer>
        
        <script>
            async function getUserID() {
                try {
                    const response = await fetch('/getUserID');
                    const data = await response.json();

                    // Return the userID or null if not found
                    return data.userID;
                } catch (error) {
                    console.error('Error fetching user ID:', error);
                    return null; // Return null in case of an error
                }
            }

            document.addEventListener("DOMContentLoaded", async () => {
                let userID = await getUserID(); 

                if (!userID) {
                    alert("Please log in to access this page.");
                    window.location.href = "loginPage.html"; // Redirect if no userID
                }
            });

            
            document.addEventListener("DOMContentLoaded", function () {
                const lostPetID = 1; // Replace with actual ID dynamically
                fetchLocationData(lostPetID);
            });
        
            let popup = document.getElementById("popup");
            let map; // Declare the map globally
        
            function openPopup() {
                popup.classList.add("open-popup");
                // If the map exists, invalidate its size after the popup is opened
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 300); // Allow time for popup to render
                }
            }
        
            function closePopup() {
                popup.classList.remove("open-popup");
            }
        
            function myFunction() {
                var navbar = document.getElementById("navLinks");
                if (navbar.classList.contains("responsive")) {
                    navbar.classList.remove("responsive");
                } else {
                    navbar.classList.add("responsive");
                }
            }
        
            async function fetchLocationData(lostPetID) {
                try {
                    const response = await fetch(`http://localhost:3000/selectedPost/${lostPetID}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
        
                    if (!response.ok) {
                        throw new Error('Failed to fetch location data');
                    }
        
                    const geoInfo = await response.json();
                    console.log("GeoLoc Pet data:", geoInfo);
        
                    if (geoInfo.length > 0) {
                        const { lastZipcode, lastCityID } = geoInfo[0];
                        console.log(`Zipcode: ${lastZipcode}, CityID: ${lastCityID}`);
        
                        getCoordinates(lastZipcode, lastCityID);
                    }
                } catch (error) {
                    console.error('Error fetching location data:', error);
                }
            }
        
            async function getCoordinates(zipcode, city) {
                const query = `${zipcode}, ${city}`;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
        
                try {
                    const response = await fetch(url);
                    const data = await response.json();
        
                    if (data.length > 0) {
                        const { lat, lon } = data[0];
                        console.log(`Coordinates: ${lat}, ${lon}`);
        
                        // Update Map
                        updateMap(lat, lon);
                    } else {
                        console.error("Location not found");
                    }
                } catch (error) {
                    console.error("Error fetching coordinates:", error);
                }
            }
        
            function updateMap(lat, lon) {
                // Initialize the map only if it's not already initialized
                if (!map) {
                    map = L.map('map').setView([lat, lon], 15); // Create map if not created yet
        
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);
        
                    L.marker([lat, lon], { title: "Last Seen Location" }).addTo(map);
                } else {
                    // If the map exists, just update the view
                    map.setView([lat, lon], 15);
                }
            }

            // sign out
            document.addEventListener("DOMContentLoaded", () => {
                const signOutButton = document.getElementById("signOut");

                if (signOutButton) {
                    signOutButton.addEventListener("click", async (event) => {
                        event.preventDefault(); // Prevent default link behavior

                        try {
                            await fetch('/logout', { method: 'POST' });
                            sessionStorage.removeItem("userID"); // Clear cache
                            window.location.href = 'loginPage.html'; // Redirect to login
                        } catch (error) {
                            console.error("Logout failed:", error);
                        }
                    });
                }
            });
        </script>
        
</body>
</html>