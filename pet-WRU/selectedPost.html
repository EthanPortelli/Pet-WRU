<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selected Pets</title>
    <link rel="stylesheet" href="selectedPostStyle.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://kit.fontawesome.com/2e1a459034.js" crossorigin="anonymous"></script>
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="navbar" id="myNavbar">
        <img src="projectImages/logo.png" alt="Logo" title="Logo of Application" height="100px">
        <div class="nav-links" id="navLinks">
            <a href="mainpage.html"><i class="fa fa-fw fa-home"></i> Home</a>
            <div class="dropdown">
                <button class="dropbtn">Posts <i class="fa fa-caret-down"></i></button>
                <div class="dropdown-content">
                    <a href="missingPetPost.html"><i class="fa-solid fa-paw"></i> Missing pets</a>
                    <a href="ReunitedPets.html"><i class="fa-solid fa-paw"></i> Reunited pets</a>
                </div>
            </div>
            <a href="donationPostPage.html"><i class="fa-solid fa-box"></i> Donations</a>
            <a href="login&signup.html" class="signout"><i class="fa-solid fa-right-to-bracket"></i> Login</a>
        </div>
        <a href="javascript:void(0);" class="icon" onclick="myFunction()">&#9776;</a>
    </div>

    <div class="post-container" id="post-container"></div>

    <section class="post-feedback">
        <h2>Comments</h2>
        <form id="feedback-form" action="#" method="POST">
            <textarea name="comment" id="comment-text" rows="5" placeholder="Write your comment here..." required></textarea>
            <button type="submit" class="submit_button"> Post</button>
        </form>
    </section>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const postID = await getPostID();
            if (postID) {
                showingSelectedPetPost(postID);
                fetchLocationData(postID);
            }
        });

        async function getPostID() {
            try {
                // Get the postID from the URL
                const urlParams = new URLSearchParams(window.location.search);
                const postID = urlParams.get('postID');  // Get the value of the postID parameter

                if (!postID) {
                    throw new Error("Post ID is missing in the URL.");
                }

                console.log('Post ID from URL:', postID);  // Log for debugging

                return postID;
            } catch (error) {
                console.error('Error getting post ID:', error);
            }
        }

        async function showingSelectedPetPost(postID) {
            console.log("Loading clicked missing pet information...");
            try {
                const response = await fetch(`http://localhost:3000/userSelectedPost/${postID}`);
                if (!response.ok) {
                    throw new Error("Failed to fetch post data");
                }

                const selectedPostArray = await response.json();  // Expecting an array here
                console.log("User Selected Missing Pet data:", selectedPostArray);

                if (selectedPostArray.length === 0) {
                    console.error("No data found for the selected post.");
                    return;
                }

                const selectedPost = selectedPostArray[0];  // Get the first item from the array
                const postContainer = document.getElementById("post-container");
                if (!postContainer) {
                    console.error("Element with ID 'post-container' not found.");
                    return;
                }
                postContainer.innerHTML = "";  // Clear any previous content

                // Rendering Post Details
                const postDiv = document.createElement("div");
                postDiv.classList.add("post-details");

                const postHeader = document.createElement("h1");
                postHeader.textContent = selectedPost.petName;

                const postImg = document.createElement("img");
                postImg.src = "projectImages/" + selectedPost.animal_image_path;

                const postUsername = document.createElement("h2");
                postUsername.textContent = `Created by: ${selectedPost.userID}`;

                const postDescription = document.createElement("p");
                postDescription.textContent = `Description: ${selectedPost.description}`;

                const postAnimalType = document.createElement("p");
                postAnimalType.textContent = `Type of Animal: ${selectedPost.animalType}`;

                const postAnimalColor = document.createElement("p");
                postAnimalColor.textContent = `Color: ${selectedPost.animalColor}`;

                const postAnimalSize = document.createElement("p");
                postAnimalSize.textContent = `Size: ${selectedPost.animalSize}`;

                const postGender = document.createElement("p");
                postGender.textContent = `Gender: ${selectedPost.animalGender}`;

                const postLastLoc = document.createElement("p");
                postLastLoc.textContent = `Last Known Location: ${selectedPost.lastCityID}`;

                const postDateMissing = document.createElement("p");
                postDateMissing.textContent = `Date Missing: ${new Date(selectedPost.dateLost).toLocaleDateString()}`;

                postDiv.append(postHeader, postImg, postUsername, postDescription, postAnimalType, postAnimalColor, postAnimalSize, postGender, postLastLoc, postDateMissing);
                postContainer.appendChild(postDiv);
            } catch (error) {
                console.error("Error loading missing pet post:", error);
            }
        }

        async function fetchLocationData(postID) {
            try {
                const response = await fetch(`http://localhost:3000/selectedPostMap/${postID}`);
                if (!response.ok) throw new Error("Failed to fetch location data");

                const geoInfo = await response.json();
                console.log("GeoLoc Pet data:", geoInfo);

                if (geoInfo.length > 0) {
                    getCoordinates(geoInfo[0].lastZipcode, geoInfo[0].lastCityID);
                }
            } catch (error) {
                console.error("Error fetching location data:", error);
            }
        }

        async function getCoordinates(zipcode, city) {
            const query = `${zipcode}, ${city}`;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.length > 0) {
                    updateMap(data[0].lat, data[0].lon);
                } else {
                    console.error("Location not found");
                }
            } catch (error) {
                console.error("Error fetching coordinates:", error);
            }
        }

        let map;
        function updateMap(lat, lon) {
            if (!map) {
                map = L.map("map").setView([lat, lon], 15);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "&copy; OpenStreetMap contributors"
                }).addTo(map);
                L.marker([lat, lon], { title: "Last Seen Location" }).addTo(map);
            } else {
                map.setView([lat, lon], 15);
            }
        }

        function myFunction() {
            const navbar = document.getElementById("navLinks");
            navbar.classList.toggle("responsive");
        }
    </script>

    <div id="popup" class="popup-container">
        <button onclick="closePopup()">Close</button>
        <div id="map" style="width: 100%; height: 400px;"></div>
    </div>

</body>
</html>
